// Â∏ÅÂÆâÈáèÂåñ‰∫§ÊòìÁõëÊéß - REST API ÂÆ¢Êà∑Á´Ø

class APITradingMonitor {
    constructor() {
        this.isMonitoring = false;
        this.updateInterval = 3000; // 3ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°
        this.intervalId = null;
        this.lastUpdate = null;

        this.init();
    }

    init() {
        this.bindEvents();
        this.updateUI();
        this.startAutoRefresh();
    }

    bindEvents() {
        // ÂºÄÂßãÁõëÊéßÊåâÈíÆ
        const startBtn = document.getElementById('start-btn');
        if (startBtn) {
            startBtn.addEventListener('click', () => this.startMonitoring());
        }

        // ÂÅúÊ≠¢ÁõëÊéßÊåâÈíÆ
        const stopBtn = document.getElementById('stop-btn');
        if (stopBtn) {
            stopBtn.addEventListener('click', () => this.stopMonitoring());
        }

        // Âà∑Êñ∞Êï∞ÊçÆÊåâÈíÆ
        const refreshBtn = document.getElementById('refresh-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => this.refreshData());
        }

        // Á≠ñÁï•ËÆæÁΩÆÊåâÈíÆ
        const settingsBtn = document.getElementById('settings-btn');
        if (settingsBtn) {
            settingsBtn.addEventListener('click', () => this.openSettings());
        }

        // Ê∏ÖÁ©∫Êó•ÂøóÊåâÈíÆ
        const clearLogBtn = document.getElementById('clear-log-btn');
        if (clearLogBtn) {
            clearLogBtn.addEventListener('click', () => this.clearLog());
        }

        // Ê®°ÊÄÅÊ°ÜÂÖ≥Èó≠
        const closeModal = document.getElementById('close-modal');
        if (closeModal) {
            closeModal.addEventListener('click', () => this.closeSettings());
        }

        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        const modal = document.getElementById('settings-modal');
        if (modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    this.closeSettings();
                }
            });
        }
    }

    updateUI() {
        this.updateConnectionStatus(true);
        this.updateMonitoringStatus(this.isMonitoring);
    }

    startAutoRefresh() {
        this.addLog('üîÑ ÂêØÂä®Ëá™Âä®Âà∑Êñ∞ (ÊØè3Áßí)', 'info');
        this.refreshData(); // Á´ãÂç≥Âà∑Êñ∞‰∏ÄÊ¨°

        this.intervalId = setInterval(() => {
            if (this.isMonitoring) {
                this.refreshData();
            }
        }, this.updateInterval);
    }

    stopAutoRefresh() {
        if (this.intervalId) {
            clearInterval(this.intervalId);
            this.intervalId = null;
            this.addLog('‚èπÔ∏è ÂÅúÊ≠¢Ëá™Âä®Âà∑Êñ∞', 'info');
        }
    }

    async refreshData() {
        try {
            this.updateLastUpdate();

            // Âπ∂Ë°åËé∑ÂèñBTCÂíåDOGEÊï∞ÊçÆ
            const [btcData, dogeData] = await Promise.all([
                this.fetchBTCData(),
                this.fetchDOGEData()
            ]);

            if (btcData && !btcData.error) {
                this.updateBTCData(btcData);
                this.addLog('üìä BTCÊï∞ÊçÆÊõ¥Êñ∞ÊàêÂäü', 'success');
            } else {
                this.addLog('‚ùå BTCÊï∞ÊçÆËé∑ÂèñÂ§±Ë¥•', 'error');
            }

            if (dogeData && !dogeData.error) {
                this.updateDOGEData(dogeData);
                this.addLog('üêï DOGEÊï∞ÊçÆÊõ¥Êñ∞ÊàêÂäü', 'success');
            } else {
                this.addLog('‚ùå DOGEÊï∞ÊçÆËé∑ÂèñÂ§±Ë¥•', 'error');
            }

        } catch (error) {
            console.error('Êï∞ÊçÆÂà∑Êñ∞Â§±Ë¥•:', error);
            this.addLog('‚ùå Êï∞ÊçÆÂà∑Êñ∞Â§±Ë¥•: ' + error.message, 'error');
        }
    }

    async fetchBTCData() {
        try {
            const response = await fetch('/api/btc-data');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return await response.json();
        } catch (error) {
            console.error('Ëé∑ÂèñBTCÊï∞ÊçÆÂ§±Ë¥•:', error);
            return { error: error.message };
        }
    }

    async fetchDOGEData() {
        try {
            const response = await fetch('/api/doge-data');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return await response.json();
        } catch (error) {
            console.error('Ëé∑ÂèñDOGEÊï∞ÊçÆÂ§±Ë¥•:', error);
            return { error: error.message };
        }
    }

    updateBTCData(data) {
        try {
            // Êõ¥Êñ∞‰ª∑Ê†º
            const priceElement = document.getElementById('btc-price');
            if (priceElement && data.price) {
                priceElement.textContent = data.price.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }

            // Êõ¥Êñ∞Ê∂®Ë∑åÂπÖ
            const changeElement = document.getElementById('btc-change');
            if (changeElement && data.change !== undefined) {
                const changeText = (data.change >= 0 ? '+' : '') + data.change.toFixed(2) + '%';
                changeElement.textContent = changeText;
                changeElement.className = data.change >= 0 ? 'positive' : 'negative';
            }

            // Êõ¥Êñ∞24hÊï∞ÊçÆ
            this.updateElement('btc-volatility', data.amplitude_24h?.toFixed(3) + '%');
            this.updateElement('btc-growth', data.growth_24h?.toFixed(2) + '%');

            // Êõ¥Êñ∞ÊäÄÊúØÊåáÊ†á
            if (data.indicators) {
                this.updateBTCIndicators(data.indicators);
            }

        } catch (error) {
            console.error('Êõ¥Êñ∞BTCÊï∞ÊçÆÂ§±Ë¥•:', error);
        }
    }

    updateDOGEData(data) {
        try {
            // Êõ¥Êñ∞‰ª∑Ê†º
            const priceElement = document.getElementById('doge-price');
            if (priceElement && data.price) {
                priceElement.textContent = data.price.toFixed(6);
            }

            // Êõ¥Êñ∞Ê∂®Ë∑åÂπÖ
            const changeElement = document.getElementById('doge-change');
            if (changeElement && data.change !== undefined) {
                const changeText = (data.change >= 0 ? '+' : '') + data.change.toFixed(2) + '%';
                changeElement.textContent = changeText;
                changeElement.className = data.change >= 0 ? 'positive' : 'negative';
            }

            // Êõ¥Êñ∞24hÊï∞ÊçÆ
            this.updateElement('doge-volatility', data.amplitude_24h?.toFixed(3) + '%');
            this.updateElement('doge-growth', data.growth_24h?.toFixed(2) + '%');

            // Êõ¥Êñ∞ÊäÄÊúØÊåáÊ†á
            if (data.indicators) {
                this.updateDOGEIndicators(data.indicators);
            }

        } catch (error) {
            console.error('Êõ¥Êñ∞DOGEÊï∞ÊçÆÂ§±Ë¥•:', error);
        }
    }

    updateBTCIndicators(indicators) {
        // 4Â∞èÊó∂ÊåáÊ†á
        if (indicators['4h']) {
            const boll4h = indicators['4h'].boll;
            const kdj4h = indicators['4h'].kdj;

            if (boll4h) {
                this.updateElement('btc-boll-4h-upper', '$' + boll4h.UP?.toLocaleString());
                this.updateElement('btc-boll-4h-middle', '$' + boll4h.MB?.toLocaleString());
                this.updateElement('btc-boll-4h-lower', '$' + boll4h.DN?.toLocaleString());
            }

            if (kdj4h) {
                this.updateElement('btc-kdj-4h-k', kdj4h.K?.toFixed(1));
                this.updateElement('btc-kdj-4h-d', kdj4h.D?.toFixed(1));
                this.updateElement('btc-kdj-4h-j', kdj4h.J?.toFixed(1));
            }
        }

        // 1Â∞èÊó∂ÊåáÊ†á
        if (indicators['1h']) {
            const boll1h = indicators['1h'].boll;
            const kdj1h = indicators['1h'].kdj;

            if (boll1h) {
                this.updateElement('btc-boll-1h-upper', '$' + boll1h.UP?.toLocaleString());
                this.updateElement('btc-boll-1h-middle', '$' + boll1h.MB?.toLocaleString());
                this.updateElement('btc-boll-1h-lower', '$' + boll1h.DN?.toLocaleString());
            }

            if (kdj1h) {
                this.updateElement('btc-kdj-1h-k', kdj1h.K?.toFixed(1));
                this.updateElement('btc-kdj-1h-d', kdj1h.D?.toFixed(1));
                this.updateElement('btc-kdj-1h-j', kdj1h.J?.toFixed(1));
            }
        }
    }

    updateDOGEIndicators(indicators) {
        const timeframes = ['1h', '15m', '1m'];

        timeframes.forEach(tf => {
            if (indicators[tf]) {
                const boll = indicators[tf].boll;
                const kdj = indicators[tf].kdj;

                if (boll) {
                    this.updateElement(`doge-boll-${tf}-upper`, '$' + boll.UP?.toFixed(6));
                    this.updateElement(`doge-boll-${tf}-middle`, '$' + boll.MB?.toFixed(6));
                    this.updateElement(`doge-boll-${tf}-lower`, '$' + boll.DN?.toFixed(6));
                }

                if (kdj) {
                    this.updateElement(`doge-kdj-${tf}-k`, kdj.K?.toFixed(1));
                    this.updateElement(`doge-kdj-${tf}-d`, kdj.D?.toFixed(1));
                    this.updateElement(`doge-kdj-${tf}-j`, kdj.J?.toFixed(1));
                }
            }
        });
    }

    updateElement(id, value) {
        const element = document.getElementById(id);
        if (element && value !== undefined && value !== 'undefined') {
            element.textContent = value;
        }
    }

    startMonitoring() {
        this.isMonitoring = true;
        this.updateMonitoringStatus(true);
        this.addLog('‚ñ∂Ô∏è ÂºÄÂßãÁõëÊéß', 'success');
    }

    stopMonitoring() {
        this.isMonitoring = false;
        this.updateMonitoringStatus(false);
        this.addLog('‚è∏Ô∏è ÂÅúÊ≠¢ÁõëÊéß', 'warning');
    }

    updateConnectionStatus(connected) {
        const statusElement = document.getElementById('connection-status');
        if (statusElement) {
            statusElement.textContent = connected ? 'Â∑≤ËøûÊé•' : 'Êú™ËøûÊé•';
            statusElement.className = 'status ' + (connected ? 'connected' : 'disconnected');
        }
    }

    updateMonitoringStatus(monitoring) {
        const statusElement = document.getElementById('monitoring-status');
        if (statusElement) {
            statusElement.textContent = monitoring ? 'ÁõëÊéß‰∏≠' : 'Â∑≤ÂÅúÊ≠¢';
            statusElement.className = 'status ' + (monitoring ? 'active' : 'stopped');
        }
    }

    updateLastUpdate() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('zh-CN', {
            hour12: false,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });

        const updateElement = document.getElementById('last-update');
        if (updateElement) {
            updateElement.textContent = timeString;
        }

        this.lastUpdate = now;
    }

    addLog(message, type = 'info') {
        const logContent = document.getElementById('log-content');
        if (logContent) {
            const timestamp = new Date().toLocaleTimeString('zh-CN', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            const logEntry = document.createElement('p');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;

            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;

            // ÈôêÂà∂Êó•ÂøóÊù°Êï∞
            const entries = logContent.querySelectorAll('.log-entry');
            if (entries.length > 100) {
                entries[0].remove();
            }
        }
    }

    clearLog() {
        const logContent = document.getElementById('log-content');
        if (logContent) {
            logContent.innerHTML = '<p class="log-entry">Êó•ÂøóÂ∑≤Ê∏ÖÁ©∫</p>';
        }
    }

    openSettings() {
        const modal = document.getElementById('settings-modal');
        if (modal) {
            modal.style.display = 'block';
        }
    }

    closeSettings() {
        const modal = document.getElementById('settings-modal');
        if (modal) {
            modal.style.display = 'none';
        }
    }
}

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', () => {
    window.tradingMonitor = new APITradingMonitor();
});